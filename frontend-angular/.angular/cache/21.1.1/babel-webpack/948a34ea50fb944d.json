{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { FormsModule } from '@angular/forms';\nimport { PDFViewerComponent } from '../pdf-viewer/pdf-viewer.component';\nimport { DrawingCanvasComponent } from '../drawing-canvas/drawing-canvas.component';\nlet ProjectEditorComponent = class ProjectEditorComponent {\n  constructor(route, apiService, stateService) {\n    this.route = route;\n    this.apiService = apiService;\n    this.stateService = stateService;\n    this.projectId = null;\n    this.pdfUrl = '';\n    this.pdfCanvas = null;\n    this.viewport = null;\n    this.markerMode = null;\n    this.markers = [];\n    this.polylines = [];\n    this.conduits = [];\n    this.markerLinks = [];\n    this.String = String; // Make String accessible in templates\n    this.stateService.markers$.subscribe(m => this.markers = m);\n    this.stateService.polylines$.subscribe(p => this.polylines = p);\n    this.stateService.conduits$.subscribe(c => this.conduits = c);\n    this.stateService.markerLinks$.subscribe(l => this.markerLinks = l);\n  }\n  ngOnInit() {\n    this.route.params.subscribe(params => {\n      this.projectId = parseInt(params['id']);\n      if (this.projectId) {\n        this.loadProject();\n      }\n    });\n  }\n  loadProject() {\n    if (!this.projectId) return;\n    this.apiService.getProject(this.projectId).subscribe(project => {\n      this.stateService.setProject(project);\n      this.pdfUrl = `${window.location.protocol}//${window.location.hostname}:8000/api/projects/${this.projectId}/pdf`;\n      this.loadProjectData();\n    }, error => console.error('Failed to load project', error));\n  }\n  loadProjectData() {\n    if (!this.projectId) return;\n    this.apiService.getMarkers(this.projectId).subscribe(markers => {\n      this.stateService.setMarkers(markers);\n    });\n    this.apiService.getPolylines(this.projectId).subscribe(polylines => {\n      this.stateService.setPolylines(polylines);\n    });\n    this.apiService.getConduits(this.projectId).subscribe(conduits => {\n      this.stateService.setConduits(conduits);\n    });\n    this.apiService.getMarkerLinks(this.projectId).subscribe(links => {\n      this.stateService.setMarkerLinks(links);\n    });\n  }\n  onCanvasReady(event) {\n    this.pdfCanvas = event.canvas;\n    this.viewport = event.viewport;\n  }\n  onPolylinesChanged(polylines) {\n    // Update polylines with the local drawing data from pdf-viewer\n    const fiberPolylines = polylines.filter(p => p.type === 'fiber').map((p, idx) => ({\n      id: -idx - 1,\n      // negative IDs for unsaved items\n      project_id: this.projectId || 0,\n      page_number: 1,\n      name: `Fiber Route ${idx + 1}`,\n      points: p.points,\n      length_ft: p.lengthFt\n    }));\n    this.polylines = fiberPolylines;\n  }\n  onTerminalsChanged(terminals) {\n    // Update markers with the local terminal data from pdf-viewer\n    this.markers = terminals.map((t, idx) => ({\n      id: -idx - 1,\n      project_id: this.projectId || 0,\n      page_number: 1,\n      x: t.x,\n      y: t.y,\n      marker_type: 'terminal'\n    }));\n  }\n  onDropsChanged(drops) {\n    // Update markers with the local drop data from pdf-viewer\n    const dropMarkers = drops.map((d, idx) => ({\n      id: -(1000 + idx),\n      project_id: this.projectId || 0,\n      page_number: 1,\n      x: d.x,\n      y: d.y,\n      marker_type: 'drop'\n    }));\n    this.markers = [...this.markers.filter(m => m.marker_type === 'terminal'), ...dropMarkers];\n  }\n  setMarkerMode(mode) {\n    this.markerMode = this.markerMode === mode ? null : mode;\n  }\n  get terminals() {\n    return this.markers.filter(m => m.marker_type === 'terminal');\n  }\n  get drops() {\n    return this.markers.filter(m => m.marker_type === 'drop' || m.marker_type === 'dropPed');\n  }\n  get fiberSegments() {\n    return this.polylines;\n  }\n  removeTerminal(terminal) {\n    this.markers = this.markers.filter(m => m !== terminal);\n  }\n  removeDrop(drop) {\n    this.markers = this.markers.filter(m => m !== drop);\n  }\n  removeFiber(fiber) {\n    if (confirm(`Delete fiber cable \"${fiber.name || 'Route'}\" (${fiber.length_ft?.toFixed(1) || '0.0'} ft)? This cannot be undone.`)) {\n      this.polylines = this.polylines.filter(p => p !== fiber);\n    }\n  }\n  removeConduit(conduit) {\n    this.conduits = this.conduits.filter(c => c !== conduit);\n  }\n  onCalibrationChanged(calibration) {\n    console.log('Calibration saved:', calibration);\n  }\n  exportPdf() {\n    if (!this.projectId) return;\n    this.apiService.exportPdf(this.projectId, 1, this.viewport?.pageWidth, this.viewport?.pageHeight).subscribe(blob => {\n      this.downloadFile(blob, `project_${this.projectId}_annotated.pdf`);\n    });\n  }\n  exportCsv() {\n    if (!this.projectId) return;\n    this.apiService.exportCsv(this.projectId).subscribe(blob => {\n      this.downloadFile(blob, `project_${this.projectId}_report.csv`);\n    });\n  }\n  downloadFile(blob, filename) {\n    const url = window.URL.createObjectURL(blob);\n    const link = document.createElement('a');\n    link.href = url;\n    link.download = filename;\n    link.click();\n    window.URL.revokeObjectURL(url);\n  }\n};\nProjectEditorComponent = __decorate([Component({\n  selector: 'app-project-editor',\n  standalone: true,\n  imports: [CommonModule, FormsModule, PDFViewerComponent, DrawingCanvasComponent],\n  template: `\n    <div *ngIf=\"projectId\" class=\"grid grid-cols-4 gap-4 h-full\">\n      <div class=\"col-span-3 flex flex-col relative\">\n        <app-pdf-viewer \n          [pdfUrl]=\"pdfUrl\"\n          [syncedTerminals]=\"terminals.filter(t => t.marker_type === 'terminal').map((t, idx) => ({x: t.x, y: t.y, id: idx}))\"\n          [syncedDrops]=\"terminals.filter(t => t.marker_type === 'drop').map((t, idx) => ({x: t.x, y: t.y, id: idx}))\"\n          (canvasReady)=\"onCanvasReady($event)\"\n          (polylinesChanged)=\"onPolylinesChanged($event)\"\n          (terminalsChanged)=\"onTerminalsChanged($event)\"\n          (dropsChanged)=\"onDropsChanged($event)\"\n        ></app-pdf-viewer>\n        <div *ngIf=\"pdfCanvas && viewport\" class=\"absolute inset-0\">\n          <app-drawing-canvas \n            [pdfCanvas]=\"pdfCanvas\"\n            [viewport]=\"viewport\"\n            [isActive]=\"markerMode === 'terminal' || markerMode === 'dropPed'\"\n            [projectId]=\"projectId\"\n          ></app-drawing-canvas>\n        </div>\n      </div>\n\n      <aside class=\"col-span-1 bg-white border rounded p-4 space-y-4 overflow-y-auto\">\n        <div class=\"space-y-2\">\n          <h3 class=\"font-semibold text-sm\">Terminals ({{ terminals.length }})</h3>\n          <ul class=\"space-y-1 text-sm text-gray-700\" *ngIf=\"terminals.length; else noTerminals\">\n            <li *ngFor=\"let t of terminals; let i = index\" class=\"flex justify-between items-center bg-gray-50 p-2 rounded\">\n              <span>Terminal {{ String.fromCharCode(65 + i) }}</span>\n              <button (click)=\"removeTerminal(t)\" class=\"text-xs text-red-600 hover:text-red-800\">Remove</button>\n            </li>\n          </ul>\n          <ng-template #noTerminals><div class=\"text-xs text-gray-500\">None placed</div></ng-template>\n        </div>\n\n        <div class=\"space-y-2\">\n          <h3 class=\"font-semibold text-sm\">Drop Peds ({{ drops.length }})</h3>\n          <ul class=\"space-y-1 text-sm text-gray-700\" *ngIf=\"drops.length; else noDrops\">\n            <li *ngFor=\"let d of drops; let i = index\" class=\"flex justify-between items-center bg-gray-50 p-2 rounded\">\n              <span>Drop Ped {{ String.fromCharCode(65 + i) }}</span>\n              <button (click)=\"removeDrop(d)\" class=\"text-xs text-red-600 hover:text-red-800\">Remove</button>\n            </li>\n          </ul>\n          <ng-template #noDrops><div class=\"text-xs text-gray-500\">None placed</div></ng-template>\n        </div>\n\n        <div class=\"space-y-2\">\n          <h3 class=\"font-semibold text-sm\">Fiber Segments ({{ fiberSegments.length }})</h3>\n          <ul class=\"space-y-1 text-sm text-gray-700\" *ngIf=\"fiberSegments.length; else noFiber\">\n            <li *ngFor=\"let seg of fiberSegments\" class=\"flex justify-between items-center bg-gray-50 p-2 rounded\">\n              <span>{{ seg.name || 'Route' }} – page {{ seg.page_number }} – {{ seg.length_ft ? seg.length_ft.toFixed(1) : '0.0' }} ft</span>\n              <button (click)=\"removeFiber(seg)\" class=\"text-xs text-red-600 hover:text-red-800\">Remove</button>\n            </li>\n          </ul>\n          <ng-template #noFiber><div class=\"text-xs text-gray-500\">No fiber drawn</div></ng-template>\n        </div>\n\n        <div class=\"space-y-2\">\n          <h3 class=\"font-semibold text-sm\">Links & Conduits ({{ conduits.length }})</h3>\n          <ul class=\"space-y-1 text-sm text-gray-700\" *ngIf=\"conduits.length; else noConduits\">\n            <li *ngFor=\"let c of conduits\" class=\"flex justify-between items-center bg-gray-50 p-2 rounded\">\n              <span>Terminal {{ c.terminal_id }} → Drop {{ c.drop_ped_id }} — {{ c.footage ? c.footage.toFixed(1) : '0.0' }} ft (page {{ c.page_number }})</span>\n              <button (click)=\"removeConduit(c)\" class=\"text-xs text-red-600 hover:text-red-800\">Remove</button>\n            </li>\n          </ul>\n          <ng-template #noConduits><div class=\"text-xs text-gray-500\">No conduits linked</div></ng-template>\n        </div>\n\n        <div class=\"space-y-2\">\n          <h3 class=\"font-semibold text-sm\">Exports</h3>\n          <div class=\"flex flex-wrap gap-2\">\n            <button (click)=\"exportPdf()\" class=\"px-3 py-2 rounded border hover:bg-gray-100\">Annotated PDF</button>\n            <button (click)=\"exportCsv()\" class=\"px-3 py-2 rounded border hover:bg-gray-100\">Materials CSV</button>\n          </div>\n        </div>\n      </aside>\n    </div>\n  `,\n  styles: [`\n    :host {\n      display: flex;\n      height: 100%;\n    }\n  `]\n})], ProjectEditorComponent);\nexport { ProjectEditorComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}