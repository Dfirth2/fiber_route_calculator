{"ast":null,"code":"import { CommonModule } from '@angular/common';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"../../core/services/state.service\";\nconst _c0 = [\"drawingCanvas\"];\nexport let DrawingCanvasComponent = /*#__PURE__*/(() => {\n  class DrawingCanvasComponent {\n    constructor(stateService) {\n      this.stateService = stateService;\n      this.pdfCanvas = null;\n      this.isActive = false;\n      this.projectId = null;\n      this.context = null;\n      this.currentPath = [];\n      this.viewportScale = 1;\n      this.pageDims = {\n        width: 1728,\n        height: 2592\n      };\n      this.isDrawing = false;\n    }\n    ngOnInit() {\n      if (this.viewport) {\n        this.viewportScale = this.viewport.scale || 1;\n        this.pageDims = {\n          width: this.viewport.pageWidth || 1728,\n          height: this.viewport.pageHeight || 2592\n        };\n      }\n    }\n    ngAfterViewInit() {\n      if (!this.pdfCanvas || !this.canvasRef) return;\n      const canvas = this.canvasRef.nativeElement;\n      canvas.width = this.pdfCanvas.width;\n      canvas.height = this.pdfCanvas.height;\n      this.context = canvas.getContext('2d');\n      this.redraw();\n    }\n    ngOnDestroy() {\n      this.context = null;\n    }\n    onCanvasClick(event) {\n      if (!this.isActive) return;\n      const rect = this.canvasRef.nativeElement.getBoundingClientRect();\n      const x = event.clientX - rect.left;\n      const y = event.clientY - rect.top;\n      const pdfCoord = this.toPdfCoordinates({\n        x,\n        y\n      });\n      // Add marker\n      if (this.projectId) {\n        const marker = {\n          id: Date.now(),\n          project_id: this.projectId,\n          page_number: 1,\n          x: pdfCoord.x,\n          y: pdfCoord.y,\n          marker_type: 'terminal'\n        };\n        this.stateService.addMarker(marker);\n        this.redraw();\n      }\n    }\n    onMouseDown(event) {\n      this.isDrawing = true;\n      this.currentPath = [];\n    }\n    onMouseMove(event) {\n      if (!this.isDrawing) return;\n      const rect = this.canvasRef.nativeElement.getBoundingClientRect();\n      const x = event.clientX - rect.left;\n      const y = event.clientY - rect.top;\n      this.currentPath.push({\n        x,\n        y\n      });\n      this.redraw();\n    }\n    onMouseUp(event) {\n      if (!this.isDrawing || this.currentPath.length < 2) {\n        this.isDrawing = false;\n        return;\n      }\n      this.isDrawing = false;\n      const pdfPoints = this.currentPath.map(p => this.toPdfCoordinates(p));\n      if (this.projectId) {\n        const polyline = {\n          id: Date.now(),\n          project_id: this.projectId,\n          page_number: 1,\n          name: `Route ${Date.now()}`,\n          points: pdfPoints,\n          length_ft: 0\n        };\n        this.stateService.addPolyline(polyline);\n        this.currentPath = [];\n        this.redraw();\n      }\n    }\n    toPdfCoordinates(canvasPoint) {\n      return {\n        x: canvasPoint.x / this.viewportScale,\n        y: canvasPoint.y / this.viewportScale\n      };\n    }\n    toCanvasCoordinates(pdfPoint) {\n      return {\n        x: pdfPoint.x * this.viewportScale,\n        y: pdfPoint.y * this.viewportScale\n      };\n    }\n    redraw() {\n      if (!this.context || !this.canvasRef) return;\n      const canvas = this.canvasRef.nativeElement;\n      this.context.clearRect(0, 0, canvas.width, canvas.height);\n      // Draw polylines\n      this.stateService.polylines$.subscribe(polylines => {\n        this.context.strokeStyle = '#3b82f6';\n        this.context.lineWidth = 2;\n        polylines.forEach(polyline => {\n          if (polyline.points.length < 2) return;\n          const p0 = this.toCanvasCoordinates(polyline.points[0]);\n          this.context.beginPath();\n          this.context.moveTo(p0.x, p0.y);\n          for (let i = 1; i < polyline.points.length; i++) {\n            const p = this.toCanvasCoordinates(polyline.points[i]);\n            this.context.lineTo(p.x, p.y);\n          }\n          this.context.stroke();\n        });\n      });\n      // Draw markers\n      this.stateService.markers$.subscribe(markers => {\n        markers.forEach(marker => {\n          const canvasCoord = this.toCanvasCoordinates({\n            x: marker.x,\n            y: marker.y\n          });\n          if (marker.marker_type === 'terminal') {\n            this.drawTerminal(canvasCoord.x, canvasCoord.y);\n          } else if (marker.marker_type === 'dropPed') {\n            this.drawDropPed(canvasCoord.x, canvasCoord.y);\n          }\n        });\n      });\n      // Draw current path\n      if (this.currentPath.length > 0) {\n        this.context.strokeStyle = '#10b981';\n        this.context.lineWidth = 2;\n        this.context.setLineDash([5, 5]);\n        const p0 = this.currentPath[0];\n        this.context.beginPath();\n        this.context.moveTo(p0.x, p0.y);\n        for (let i = 1; i < this.currentPath.length; i++) {\n          const p = this.currentPath[i];\n          this.context.lineTo(p.x, p.y);\n        }\n        this.context.stroke();\n        this.context.setLineDash([]);\n      }\n    }\n    drawTerminal(x, y) {\n      if (!this.context) return;\n      const size = 15;\n      const height = size * Math.sqrt(3) / 2;\n      this.context.fillStyle = '#10b981';\n      this.context.strokeStyle = '#ffffff';\n      this.context.lineWidth = 2;\n      this.context.beginPath();\n      this.context.moveTo(x, y - height);\n      this.context.lineTo(x - size / 2, y + height / 2);\n      this.context.lineTo(x + size / 2, y + height / 2);\n      this.context.closePath();\n      this.context.fill();\n      this.context.stroke();\n    }\n    drawDropPed(x, y) {\n      if (!this.context) return;\n      const radius = 12;\n      this.context.fillStyle = '#a855f7';\n      this.context.strokeStyle = '#ffffff';\n      this.context.lineWidth = 2;\n      this.context.beginPath();\n      this.context.arc(x, y, radius, 0, 2 * Math.PI);\n      this.context.fill();\n      this.context.stroke();\n    }\n    static {\n      this.ɵfac = function DrawingCanvasComponent_Factory(__ngFactoryType__) {\n        return new (__ngFactoryType__ || DrawingCanvasComponent)(i0.ɵɵdirectiveInject(i1.StateService));\n      };\n    }\n    static {\n      this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n        type: DrawingCanvasComponent,\n        selectors: [[\"app-drawing-canvas\"]],\n        viewQuery: function DrawingCanvasComponent_Query(rf, ctx) {\n          if (rf & 1) {\n            i0.ɵɵviewQuery(_c0, 5);\n          }\n          if (rf & 2) {\n            let _t;\n            i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.canvasRef = _t.first);\n          }\n        },\n        inputs: {\n          pdfCanvas: \"pdfCanvas\",\n          viewport: \"viewport\",\n          isActive: \"isActive\",\n          projectId: \"projectId\"\n        },\n        decls: 2,\n        vars: 2,\n        consts: [[\"drawingCanvas\", \"\"], [1, \"absolute\", \"inset-0\", \"cursor-crosshair\", 3, \"click\", \"mousemove\", \"mousedown\", \"mouseup\"]],\n        template: function DrawingCanvasComponent_Template(rf, ctx) {\n          if (rf & 1) {\n            const _r1 = i0.ɵɵgetCurrentView();\n            i0.ɵɵdomElementStart(0, \"canvas\", 1, 0);\n            i0.ɵɵdomListener(\"click\", function DrawingCanvasComponent_Template_canvas_click_0_listener($event) {\n              i0.ɵɵrestoreView(_r1);\n              return i0.ɵɵresetView(ctx.onCanvasClick($event));\n            })(\"mousemove\", function DrawingCanvasComponent_Template_canvas_mousemove_0_listener($event) {\n              i0.ɵɵrestoreView(_r1);\n              return i0.ɵɵresetView(ctx.onMouseMove($event));\n            })(\"mousedown\", function DrawingCanvasComponent_Template_canvas_mousedown_0_listener($event) {\n              i0.ɵɵrestoreView(_r1);\n              return i0.ɵɵresetView(ctx.onMouseDown($event));\n            })(\"mouseup\", function DrawingCanvasComponent_Template_canvas_mouseup_0_listener($event) {\n              i0.ɵɵrestoreView(_r1);\n              return i0.ɵɵresetView(ctx.onMouseUp($event));\n            });\n            i0.ɵɵdomElementEnd();\n          }\n          if (rf & 2) {\n            i0.ɵɵstyleProp(\"pointer-events\", ctx.isActive ? \"auto\" : \"none\");\n          }\n        },\n        dependencies: [CommonModule],\n        encapsulation: 2\n      });\n    }\n  }\n  return DrawingCanvasComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}