# Fiber Route Plat Designer
BY dfirth2

A web application for measuring fiber routes from subdivision plats. Upload a PDF plat, calibrate the scale, trace fiber paths, and export accurate footage calculations for network design documenta

## What this app does
- Upload subdivision plat PDFs and browse pages.
- Calibrate scale by clicking two points and entering the real-world distance.
- Draw fiber routes on top of the PDF with undo/clear and save per route.
- See segment-by-segment distances and total footage using the saved scale factor.
- Export measurements as CSV or JSON for handoff and reporting.

## Intial update
- Fixed PDF.js worker loading so PDFs render in both dev and deployed builds.
- Added two-point scale calibration flow with persistence and restored points.
- Implemented pan/draw modes, undo and clear shortcuts, and save/calc buttons for routes.
- Added segment distance panel showing per-segment lengths and totals while drawing.
- Backend fixes for route saving (SQLAlchemy func import/usage) and updated deployment docs.

## Update 1
- Unit Testing

## Update 2
- Added terminals, Drops peds, conduits, Assigning Lots to Terminals and pedestals
- Added Exporting to PDF
- Fixed critical coordinate alignment issues for markers and PDF export
- Resolved zoom handling - markers now stay in correct position when zooming in/out
- Fixed PDF rotation support (handles 270° rotated PDFs correctly)
- Implemented proper coordinate transformation between canvas space and PDF space
- Frontend now passes page dimensions to backend for accurate overlay rendering
- All markers, routes, conduits, and annotations now export at exact positions

## Update 3
- **Frontend Migration**: Converted from React to Angular 21.1.1
  - Angular standalone components with TypeScript 5.2.0
  - Integrated Tailwind CSS for consistent styling
  - Updated module resolution to "bundler" for Angular 21 ESM compatibility
  - Successfully compiling and serving on port 3000 (mapped from Angular dev server on port 4200)
- **Backend Updates**: 
  - Migrated from deprecated PyPDF2 to pypdf 5.1.0
  - Updated SQLAlchemy to >=2.0.25 with proper declarative_base imports
  - Updated pydantic to >=2.10.0 with ConfigDict for settings
  - Updated Pillow to >=11.0.0 for Python 3.13 compatibility
  - Fixed timezone-aware datetime defaults for database models
  - Added pytest.ini to filter third-party deprecation warnings
  - All tests passing with zero warnings on Python 3.13
  - Added dual database support: SQLite for development, PostgreSQL for production
  - Environment-based configuration with automatic database selection
- **Project Management Enhancements**:
  - Projects now display in clean table layout with name, footage, and actions
  - Project name is clickable link to editor
  - Auto-navigation to editor after project creation
  - Auto-refresh project list when returning from editor
  - Delete confirmation with loading overlay and table refresh
  - Loading states for all async operations
- **Calibration Improvements**:
  - Calibration now strictly project-specific (stored in database only)
  - Removed localStorage fallback to prevent cross-project contamination
  - Each project requires its own calibration
  - Mode automatically switches to 'pan' after successful calibration
  - Clear user prompts when calibration is required
- **Infrastructure**:
  - Updated docker-compose.yml to use frontend-angular instead of React frontend
  - Fixed Angular Docker configuration with proper dev server binding (--host 0.0.0.0)
  - Angular app successfully compiles with no TypeScript errors
  - Refactored large inline templates to separate HTML files for better maintainability

## Update 4
- **Assignment System**:
  - Implemented "Assign" tool to create directional arrows from terminals/drops to lot locations
  - Assignments stored in backend database with proper marker ID validation
  - Backend validates marker existence before creating assignments (prevents 404 errors)
  - Assignments persist and load correctly with database-backed marker IDs
  - Fixed race conditions between marker saving and assignment creation
  - Yellow highlight shows selected marker when creating assignments
  - Orange arrows render from markers to assigned lot positions
- **Drop Conduit Management**:
  - Separated drop conduits from fiber routes in UI
  - New "Drop Conduits" section in sidebar showing connection details
  - Displays what each conduit connects (e.g., "Terminal A → Drop Ped C — 45.2 ft")
  - Conduits track both source and destination markers with distance
  - Equipment menu now shows "Drop Conduit" instead of generic "Conduit"
  - Conduit metadata properly tracks fromId, fromType, toId, toType, and lengthFt
- **Erase Mode**:
  - Added comprehensive erase functionality for all drawable elements
  - Click on assignments (arrows), markers, fiber routes, or conduits to delete
  - Smart detection with reasonable click radius for easier selection
  - Visual feedback with red button highlight and "not-allowed" cursor
  - Works with both local storage and backend-persisted data
  - Shows success/error toasts with appropriate colors
- **UI/UX Improvements**:
  - Toast notifications now color-coded: green for success, red for errors, blue for info
  - Toolbar stats now show "Fiber Routes: X (YYY ft)" and "Drop Conduits: X (YYY ft)"
  - Sidebar renamed "Fiber Segments" to "Fiber Cable" for clarity
  - Consistent labeling: "Drop Ped" used throughout instead of inconsistent "Drop"
  - Helper messages show mode-specific instructions (calibrate, assign, erase)
- **Code Quality**:
  - Added proper TypeScript typing for all new features
  - Implemented event emitters for conduit changes
  - Proper separation of concerns between fiber routes and conduits
  - Helper methods for geometric calculations (distance to line segment)
  - Cleaned up duplicate code and improved maintainability

## Update 5
- **Conduit Persistence System**:
  - Fixed critical marker ID synchronization bug between PDF viewer and project editor
  - Replaced ID-based marker lookup with coordinate-based lookup for reliability
  - Conduit metadata now stores coordinates (fromX, fromY, toX, toY) alongside IDs
  - Conduits properly save to database with correct marker references
  - Conduits persist and reload correctly after page refresh
  - Resolved race condition where local IDs didn't match database IDs
  - Conduit relationships now track which drops connect to terminals for assignment aggregation
- **Polyline Persistence**:
  - Fixed conduit polylines not displaying after reload
  - Polylines now emit change event when conduits are drawn (previously only stored locally)
  - Backend correctly distinguishes between fiber routes and conduits via polyline type field
  - Loaded polylines automatically get type field inferred from name ("Fiber" vs "Conduit")
  - All polylines (fiber and conduit) properly sync and render on canvas after project reload
- **Calibration Dialog**:
  - Replaced browser prompt() with professional modal dialog
  - Dialog validates input to only accept numeric values
  - Shows error message "Please enter a valid positive number" if validation fails
  - Dialog remains open if input is invalid, allowing user to correct and retry
  - Fixed modal positioning to center on screen (changed from absolute to fixed)
  - User can submit with Enter key or Cancel button
  - Calibration points are properly reset on cancel
- **Data Synchronization**:
  - Added `[syncedConduits]` input to PDF viewer component
  - Project editor passes conduit metadata to PDF viewer for rendering
  - ngOnChanges handler properly clones conduit data to avoid reference issues
  - Polylines, terminals, drops, and conduits all sync between components correctly
  - Project reload now displays all saved markers, polylines, conduits, and conduit lines
- **Type System**:
  - Updated conduit metadata TypeScript interface with optional coordinate fields
  - Proper typing for polyline objects with type field ('fiber' | 'conduit')
  - Added FormsModule import for two-way binding in calibration dialog
  - Type safety maintained throughout persistence workflow
- **Infrastructure**:
  - Backend PDF deletion already implemented (removed from /tmp/fiber_uploads on project delete)
  - Polyline save endpoint correctly persists both fiber routes and conduits
  - Conduit endpoint validates terminal and drop pedestal existence (404 prevention)
  - All endpoints properly cascade delete related data when project is deleted

## Update 6 - Production Deployment & Interaction Fixes
- **CORS and API Configuration**:
  - Fixed 404 errors when accessing PDF endpoint through Tailscale hostname
  - Updated frontend API URL construction to use nginx proxy (`/api`) in production
  - Added Tailscale hostname to CORS_ORIGINS in backend configuration
  - Frontend now correctly uses relative paths when not on localhost
  - PDF URLs properly constructed for both development and production environments
  - Removed hardcoded port 8000 references in production (uses nginx on port 80)
- **PDF Pan/Zoom Interaction**:
  - Fixed PDF snapping to top-left corner when switching between tools
  - Removed `panOffset` reset in `setMode()` function to maintain PDF position
  - PDF position now preserved when switching from pan to calibrate/equipment/fiber modes
  - Users can zoom to area of interest and switch tools without losing position
- **Erase Functionality**:
  - Fixed erase mode unable to detect items after panning
  - Moved mouse event handlers from outer container to transformed wrapper div
  - Click coordinates now properly aligned with canvas content accounting for pan transform
  - Erase works correctly regardless of zoom level or pan position
- **Marker Deletion**:
  - Fixed 404 errors when attempting to delete markers
  - Corrected `syncedTerminalsList` and `syncedDropsList` to use actual database IDs
  - Previously used array indices as marker IDs, causing database lookup failures
  - Now properly passes marker ID, coordinates, and marker_type from database
  - Delete operations successfully remove markers from backend and update UI
- **Code Architecture**:
  - Improved coordinate transformation handling in mouse event processing
  - Better separation between canvas coordinate space and screen space
  - Mouse handlers attached to correct DOM elements for transform calculations
  - Enhanced reliability of click detection for all interactive elements

## Update 7 - Multi-Page PDF Support with Per-Page Calibration
- **Per-Page Scale Calibration**:
  - Each page in a multi-page PDF can now have its own scale calibration
  - Calibration automatically loads when navigating between pages
  - Clear toast notifications indicate which page calibration is loaded
  - Warns user if current page hasn't been calibrated yet
  - Prevents using incorrect scale from different pages
- **Page-Specific Content Filtering**:
  - Markers (terminals and drop pedestals) only display on the page they were created on
  - Fiber routes and conduits are page-specific
  - Lot assignments filtered by page
  - Page navigation automatically reloads content for the current page
- **Page Navigation Enhancements**:
  - Next/Previous page buttons reload calibration for new page
  - Markers automatically filter to show only current page items
  - Polylines tracked with page numbers for proper filtering
  - Conduit metadata includes page numbers
- **Data Structure Updates**:
  - Polylines now store `pageNumber` property
  - All markers saved with current `page_number`
  - Assignments linked to specific pages
  - Backend already supported page-specific data, now fully utilized in frontend
- **User Experience**:
  - Seamless page switching without data contamination between pages
  - Each page maintains independent scale and annotations
  - Supports complex subdivision plats spanning multiple pages with different scales
  - Clear feedback when page needs calibration

  ## Update 12 - Cable Builder & Cable Counts
  - **Cable Builder Feature**:
    - New Cable Builder screen for configuring terminals, cables, and teather splicers
    - Drag terminals to assign them to specific cables
    - Terminals show letter labels (A, B, C, …) consistent with PDF viewer ordering
    - Cable count limit is enforced based on fiber route polylines (excludes drop conduits)
  - **Backend Additions**:
    - New cable configuration models, schemas, service logic, and API routes
    - Cable-counts endpoint returns terminal assignments (includes drop ped assignments)
    - Circular teather detection and cable type/size validation
    - Comprehensive unit tests added for cable service logic
  - **Frontend Enhancements**:
    - Cable Builder UI with drag-drop ordering and terminal-to-cable assignment
    - “Build Cable Counts” button replaces Materials CSV in the editor
    - Button opens in a new tab; Back button returns to the original tab when available
    - Updated Angular CDK version to match Angular 19

## Update 8 - Handhole Equipment Type & Conduit Refinements
- **New Handhole Equipment Type**:
  - Added handhole as third equipment type (alongside terminals and drop pedestals)
  - Handholes render as purple squares with hollow white center for visual distinction
  - Handholes are material-countable (appear in Equipment Summary)
  - Handholes can be assigned to lots via assignment arrows
  - Handholes explicitly cannot be endpoints for drop conduits (enforced in frontend)
  - Handholes not displayed in sidebar equipment list but included in aggregate counts
- **Handholes in Sidebar**:
  - Handholes count displayed in sidebar after Drop Conduits section
  - Shows total handhole count for current page (not expandable)
  - Integrates cleanly with existing sidebar equipment layout
  - Provides quick reference to handhole material count
- **Conduit Logic Fixes**:
  - Fixed conduit label pairing - terminals and drop pedestals now correctly paired
  - Terminals now show proper assignment aggregation (direct assignments + connected drop ped assignments)
  - Added validation modal for conduit creation with three required checks:
    1. First point must be a terminal ("Pick a terminal first")
    2. Terminal cannot have more than 2 conduits ("max two conduits")
    3. Second point must be a drop pedestal ("must select a drop pedestal")
  - Conduits now separately numbered from fiber routes ("Fiber Route 1, 2..." vs "Drop Conduit 1, 2...")
- **Marker Preservation**:
  - All marker types (terminals, drops, handholes) properly preserved during component updates
  - Marker types cleanly separated in data structure via `marker_type` field
  - Assignments work with all marker types for lot assignment workflows
- **Polyline Improvements**:
  - Fixed footage disappearing on second fiber route creation
  - Polyline length property properly transformed to match PDF viewer expectations
  - Multiple polylines now persist correctly across renders
- **UI/UX Refinements**:
  - Removed assignment badges from drop pedestals (rolled up to terminals)
  - Removed "Connected Drops" nested list from sidebar (cleaner UI)
  - Equipment type selection menu now includes "Handhole" option
  - Conduit creation flow provides clear error messages for invalid connections
- **Backend Marker System**:
  - Generic marker system using `marker_type` field supports unlimited equipment types
  - Backend already supports handhole storage without code changes
  - Marker relationships (via `MarkerLink` table) support all marker types
  - Database schema flexible for future equipment type additions
- **Testing Coverage**:
  - 8 comprehensive backend unit tests for handhole functionality
  - Tests cover creation, retrieval, page filtering, deletion, assignments
  - Tests enforce handhole constraints (no conduit endpoints)
  - 25+ frontend unit tests for handhole placement, rendering, synchronization
  - All tests passing with production-ready code quality
- **Code Quality**:
  - Separate marker arrays for terminals, drops, handholes with proper filtering
  - Clean separation between equipment types in rendering and UI logic
  - Type-safe TypeScript implementation with proper interfaces
  - EventEmitter pattern for syncing markers between components
  - Comprehensive test coverage ensures stability of new feature

## Update 9 - Enhanced Visual Rendering & Export Features
- **Handhole Rendering Order**:
  - Handholes now render first (bottom layer) so everything appears on top
  - Polylines, conduits, and assignments render over handholes
  - Terminals and drop pedestals render last (top layer) for maximum visibility
  - Consistent rendering order across both PDF viewer and exported PDFs
  - Eliminates visual confusion when handholes overlap with other elements
- **Erase Tool Enhancements**:
  - Erase tool now properly detects and deletes handholes
  - Updated `findMarkerAtPoint` to check all three marker types (terminals, drops, handholes)
  - Updated `deleteMarker` to handle handhole deletion with proper event emission
  - Fixed TypeScript type signatures to include 'handhole' in marker union types
  - Added detailed console logging for debugging marker detection
  - Comprehensive deletion support for all drawable elements
- **PDF Export Filename Customization**:
  - Added modal dialog for custom PDF export filenames
  - Default filename pre-populated with project name
  - Users can edit filename before export
  - Automatic .pdf extension handling (adds if missing)
  - Filename sanitization to replace special characters with underscores
  - Enter key support for quick export confirmation
  - Clean modal UI matching existing project details dialog
  - Export button disabled if filename is empty
- **Export Filename Consistency**:
  - CSV export uses sanitized project name: `{project_name}_report.csv`
  - JSON export uses sanitized project name: `{project_name}_report.json`
  - PDF export uses user-provided custom name or defaults to project name
  - All filenames sanitized for cross-platform compatibility
  - Special characters, spaces replaced with underscores in backend
- **Drop Conduit Visual Fix**:
  - Drop conduits in exported PDF now render as solid purple lines
  - Removed dashed line pattern that was showing green fiber routes underneath
  - Conduits maintain 3px line width for clear visibility
  - Consistent purple color (#9333ea) across viewer and export
- **Code Architecture**:
  - Updated PDF overlay service with proper layer ordering
  - Separated handhole rendering from other markers in export logic
  - Added `projectName` property to project editor component
  - Modal state management with `showPdfExportModal` flag
  - `confirmPdfExport()` method handles validation and export flow
  - Proper TypeScript typing for all new modal functionality

## Update 10 - Fiber Route Labeling & PDF Export Overlay Alignment
- **Fiber Route Identification System**:
  - Fiber routes now display numbered identifiers (1, 2, 3...) in green circles
  - Labels positioned at 25% and 75% of route length for longer routes
  - Adaptive positioning: single label at midpoint if route < 300px
  - Labels only appear on actual fiber routes (>= 150px) to exclude drop conduits
  - Green circle styling (#22c55e) with white center text for clear visibility
- **Sidebar Route Identification**:
  - Fiber Cable list in sidebar now displays matching numbered identifiers
  - Each route shows as "1: Fiber Cable (XX.X ft)" with corresponding route number
  - Consistent numbering between viewer and sidebar for quick reference
- **PDF Export Overlay Alignment**:
  - Fixed critical coordinate transformation for rotated PDFs
  - Properly handles 270° rotated PDFs with vertical mirroring
  - Coordinate formula: `new_x = height - y`, `new_y = canvas_height - x`
  - Frontend now emits viewport dimensions from PDF viewer to project editor
  - Backend receives correct page dimensions for accurate overlay positioning
  - All markers, routes, and labels now export at exact positions matching viewer
- **Viewport Dimension Communication**:
  - Added `@Output() viewportChanged` EventEmitter to pdf-viewer component
  - pdf-viewer emits viewport object on each page render
  - project-editor listens with `(viewportChanged)="onViewportChanged($event)"`
  - Export endpoint receives `page_width` and `page_height` query parameters
  - Backend uses received dimensions for accurate coordinate transformations
- **Text Rendering & Orientation**:
  - Removed manual text rotation to let PDF viewer handle orientation naturally
  - Labels render without rotation, allowing PDF viewer to apply proper orientation
  - Text displays correctly on rotated PDFs without manual angle calculations
  - Consistent text orientation matching PDF page layout
- **Drop Conduit Label Filtering**:
  - Length threshold (150px minimum) applied to route labeling
  - Drop conduits < 150px do not receive labels or identifiers
  - Only meaningful fiber routes get numbered identifiers
  - Reduces visual clutter on exported PDFs by eliminating conduit labels
- **Rendering Architecture**:
  - Render order on export: Handholes → Polylines → Conduits → Arrows → Terminals/Drops
  - Label positioning calculated for each polyline individually
  - Terminal and drop labels rendered last for maximum visibility
  - Color coding maintained: green for fiber routes, colored shapes for terminals/drops
- **Code Quality**:
  - Coordinate transformation fully debugged and tested
  - Frontend-backend dimension passing properly implemented
  - Label positioning logic handles variable route lengths
  - TypeScript event emitter pattern for robust dimension passing
  - Backend ReportLab canvas operations tested with real PDF exports

## Update 11 - Hardened Save Project to Prevent Duplicate Conduits/Terminals
- **Duplicate Data Prevention**:
  - Fixed critical bug where saveProject() was saving ALL conduits/terminals, not just new ones
  - Root cause: No tracking of which items were already saved vs. newly created
  - Solution: Added `id` field to conduitMetadata to distinguish saved from new items
- **Conduit Tracking System**:
  - Database conduits loaded with their `id` property preserved
  - New conduits created in UI assigned negative IDs (like markers/polylines)
  - `onConduitsChanged()` now assigns unique negative IDs to freshly drawn conduits
  - Prevents duplicate saves by filtering: `newConduits = conduitMetadata.filter(c => !c.id || c.id < 0)`
- **Save Logic Improvements**:
  - `saveProject()` now saves only new conduits (negative/undefined IDs)
  - `saveProjectBeforeExport()` updated with same duplicate prevention logic
  - Prevents re-saving already persisted conduits/terminals on subsequent saves
  - Consistent with existing marker/polyline save patterns
- **Type Safety**:
  - Updated TypeScript interface to include optional `id?: number` field
  - Maintains backward compatibility while enabling ID tracking
  - Properly typed for both positive (saved) and negative (new) ID values
- **Testing Impact**:
  - Frontend build: 808.15 kB, no TypeScript errors
  - No API changes required - backend already supports proper data handling
  - Existing saved data not affected - only new saves filtered correctly
- **User Impact**:
  - Save button no longer doubles terminals/conduits on repeated clicks
  - Projects can be saved multiple times without data duplication
  - Performance improved by avoiding redundant API calls
  - User experience more reliable with predictable data state
